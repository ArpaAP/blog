---
import BaseLayout from "@/layouts/BaseLayout.astro";
import CodeBlock from "@/components/mdx/CodeBlock.astro";
import GiscusComments from "@/components/GiscusComments.astro";
import { getCollection, render } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";

export async function getStaticPaths() {
  const posts = await getCollection("articles");
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<"articles">;
}

const { post } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(post);
const ogImage = post.data.feature_image
  ? new URL(post.data.feature_image.src, Astro.site).href
  : undefined;
const minDepth =
  headings.length > 0 ? Math.min(...headings.map((h) => h.depth)) : 1;
const readingTime = remarkPluginFrontmatter?.minutesRead;

const date = new Date(post.data.published_at).toLocaleDateString("ko-KR", {
  weekday: "long",
  year: "numeric",
  month: "long",
  day: "numeric",
});

const articleUrl = new URL(`/articles/${post.id}`, Astro.site).href;
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.data.title,
  ...(post.data.excerpt && { description: post.data.excerpt }),
  datePublished: post.data.published_at.toISOString(),
  url: articleUrl,
  ...(ogImage && { image: ogImage }),
  author: {
    "@type": "Person",
    name: "Buyeon Hwang",
    url: "https://arpaap.dev",
  },
  publisher: {
    "@type": "Person",
    name: "Buyeon Hwang",
    url: "https://arpaap.dev",
  },
};
---

<BaseLayout
  title={`${post.data.title} - Devlog Alpha`}
  description={post.data.excerpt}
  transparentNavbar={!!post.data.feature_image}
  ogImage={ogImage}
  ogType="article"
>
  <script slot="head" is:inline type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  {
    post.data.feature_image ? (
      <div
        slot="hero"
        class="relative w-full h-[60vh] min-h-[480px] flex items-center justify-center overflow-hidden bg-gray-900 mb-12"
      >
        <div class="absolute inset-0 z-0">
          <Image
            src={post.data.feature_image}
            alt={post.data.feature_image_alt || post.data.title}
            class="w-full h-full object-cover opacity-60 blur-sm scale-105"
          />
          <div class="absolute inset-0 bg-black/40" />
        </div>

        <div class="relative z-10 w-full max-w-4xl mx-auto px-6 text-center">
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white tracking-tight leading-tight drop-shadow-lg mt-8 mb-12">
            {post.data.title}
          </h1>

          <div class="flex flex-col items-center justify-center gap-2 text-sm font-medium text-gray-200">
            {post.data.tags && post.data.tags.length > 0 && (
              <div class="flex flex-wrap items-center justify-center gap-2 mb-1">
                {post.data.tags.map((tag) => (
                  <span class="text-brand-300 text-base">#{tag}</span>
                ))}
              </div>
            )}
            <div class="flex items-center gap-3">
              <time datetime={post.data.published_at.toISOString()}>
                {date}
              </time>
              {readingTime && (
                <>
                  <span class="text-gray-400">&bull;</span>
                  <span class="text-gray-300">{readingTime}</span>
                </>
              )}
            </div>
          </div>
        </div>
      </div>
    ) : null
  }

  <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-12">
    <article class="w-full lg:w-[80%] min-w-0">
      <div class="mb-8">
        <a
          href="/articles"
          class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-brand-600 transition-colors"
        >
          &larr; 목록으로
        </a>
      </div>

      {
        !post.data.feature_image && (
          <header class="mb-12 border-b border-gray-200 dark:border-gray-700 pb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-gray-100 leading-tight mb-4">
              {post.data.title}
            </h1>

            <div class="flex flex-col gap-2 text-sm text-gray-500">
              <div class="flex items-center gap-2">
                {post.data.tags.map((tag) => (
                  <span class="text-brand-600 dark:text-brand-300 font-medium text-base">
                    #{tag}
                  </span>
                ))}
              </div>
              <div class="flex items-center gap-2">
                <time datetime={post.data.published_at.toISOString()}>
                  {date}
                </time>
                {readingTime && (
                  <>
                    <span>&bull;</span>
                    <span>{readingTime}</span>
                  </>
                )}
              </div>
            </div>
          </header>
        )
      }

      <div
        class="prose prose-h1:text-[32px] prose-pre:my-0 prose-slate dark:prose-invert prose-headings:font-bold prose-headings:tracking-tight prose-a:text-brand-600 dark:prose-a:text-brand-300 max-w-none"
      >
        <Content components={{ pre: CodeBlock }} />
      </div>

      <GiscusComments />
    </article>

    <aside class="hidden lg:block w-[20%] shrink-0">
      <div class="sticky top-24 pt-4">
        <h2
          class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4"
        >
          On this page
        </h2>
        <nav
          class="max-h-[calc(100vh-10rem)] overflow-y-auto pr-2 scrollbar-hide"
        >
          <ul
            class="space-y-1 text-sm border-l-2 border-transparent hover:border-gray-200 dark:hover:border-neutral-800 transition-colors duration-200"
          >
            {
              headings.map((heading) => (
                <li>
                  <a
                    href={`#${heading.slug}`}
                    class="toc-link block py-1 -ml-[2px] text-gray-500 hover:text-gray-900 dark:text-neutral-500 dark:hover:text-neutral-300 transition-all duration-200 border-l-2 border-transparent hover:border-gray-300"
                    data-slug={heading.slug}
                    style={{
                      paddingLeft: `${1 + (heading.depth - minDepth) * 0.75}rem`,
                    }}
                  >
                    {heading.text}
                  </a>
                </li>
              ))
            }
          </ul>
        </nav>
      </div>
    </aside>
  </div>

  <script>
    const ACTIVE_CLASSES = [
      "!text-brand-600",
      "dark:!text-brand-300",
      "!font-bold",
      "!border-brand-600",
      "dark:!border-brand-300",
    ];

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.getAttribute("id");
            document.querySelectorAll(".toc-link").forEach((l) => {
              l.classList.remove(...ACTIVE_CLASSES);
            });

            const link = document.querySelector(`.toc-link[data-slug="${id}"]`);
            if (link) {
              link.classList.add(...ACTIVE_CLASSES);
              link.scrollIntoView({ block: "nearest", behavior: "smooth" });
            }
          }
        });
      },
      {
        rootMargin: "-100px 0px -66% 0px",
      },
    );

    document
      .querySelectorAll(".prose h1, .prose h2, .prose h3, .prose h4")
      .forEach((heading) => {
        observer.observe(heading);
      });

    document.querySelectorAll(".toc-link").forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const targetId = link.getAttribute("href")?.substring(1);
        const target = document.getElementById(targetId!);
        if (target) {
          window.scrollTo({
            top: target.offsetTop - 100,
            behavior: "smooth",
          });
          history.pushState(null, "", `#${targetId}`);
        }
      });
    });
  </script>
</BaseLayout>
